var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};function e(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var n=function(){return n=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},n.apply(this,arguments)};function r(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{u(r.next(t))}catch(t){o(t)}}function a(t){try{u(r.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}u((r=r.apply(t,e||[])).next())}))}function i(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(u){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}function o(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function s(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function a(t,e,n){if(n||2===arguments.length)for(var r,i=0,o=e.length;i<o;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))}function u(t){return this instanceof u?(this.v=t,this):new u(t)}function c(t,e,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(t,e||[]),o=[];return r={},s("next"),s("throw"),s("return"),r[Symbol.asyncIterator]=function(){return this},r;function s(t){i[t]&&(r[t]=function(e){return new Promise((function(n,r){o.push([t,e,n,r])>1||a(t,e)}))})}function a(t,e){try{(n=i[t](e)).value instanceof u?Promise.resolve(n.value.v).then(c,l):h(o[0][2],n)}catch(t){h(o[0][3],t)}var n}function c(t){a("next",t)}function l(t){a("throw",t)}function h(t,e){t(e),o.shift(),o.length&&a(o[0][0],o[0][1])}}function l(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,n=t[Symbol.asyncIterator];return n?n.call(t):(t=o(t),e={},r("next"),r("throw"),r("return"),e[Symbol.asyncIterator]=function(){return this},e);function r(n){e[n]=t[n]&&function(e){return new Promise((function(r,i){(function(t,e,n,r){Promise.resolve(r).then((function(e){t({value:e,done:n})}),e)})(r,i,(e=t[n](e)).done,e.value)}))}}}function h(t){return"function"==typeof t}function d(t){var e=t((function(t){Error.call(t),t.stack=(new Error).stack}));return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}"function"==typeof SuppressedError&&SuppressedError;var p=d((function(t){return function(e){t(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map((function(t,e){return e+1+") "+t.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e}}));function f(t,e){if(t){var n=t.indexOf(e);0<=n&&t.splice(n,1)}}var g=function(){function t(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}var e;return t.prototype.unsubscribe=function(){var t,e,n,r,i;if(!this.closed){this.closed=!0;var u=this._parentage;if(u)if(this._parentage=null,Array.isArray(u))try{for(var c=o(u),l=c.next();!l.done;l=c.next()){l.value.remove(this)}}catch(e){t={error:e}}finally{try{l&&!l.done&&(e=c.return)&&e.call(c)}finally{if(t)throw t.error}}else u.remove(this);var d=this.initialTeardown;if(h(d))try{d()}catch(t){i=t instanceof p?t.errors:[t]}var f=this._finalizers;if(f){this._finalizers=null;try{for(var g=o(f),b=g.next();!b.done;b=g.next()){var v=b.value;try{y(v)}catch(t){i=null!=i?i:[],t instanceof p?i=a(a([],s(i)),s(t.errors)):i.push(t)}}}catch(t){n={error:t}}finally{try{b&&!b.done&&(r=g.return)&&r.call(g)}finally{if(n)throw n.error}}}if(i)throw new p(i)}},t.prototype.add=function(e){var n;if(e&&e!==this)if(this.closed)y(e);else{if(e instanceof t){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=null!==(n=this._finalizers)&&void 0!==n?n:[]).push(e)}},t.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},t.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},t.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&f(e,t)},t.prototype.remove=function(e){var n=this._finalizers;n&&f(n,e),e instanceof t&&e._removeParent(this)},t.EMPTY=((e=new t).closed=!0,e),t}(),b=g.EMPTY;function v(t){return t instanceof g||t&&"closed"in t&&h(t.remove)&&h(t.add)&&h(t.unsubscribe)}function y(t){h(t)?t():t.unsubscribe()}var m={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},w={setTimeout:function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return setTimeout.apply(void 0,a([t,e],s(n)))},clearTimeout:function(t){return clearTimeout(t)},delegate:void 0};function E(t){w.setTimeout((function(){throw t}))}function A(){}function S(t){t()}var $=function(t){function n(e){var n=t.call(this)||this;return n.isStopped=!1,e?(n.destination=e,v(e)&&e.add(n)):n.destination=R,n}return e(n,t),n.create=function(t,e,n){return new k(t,e,n)},n.prototype.next=function(t){this.isStopped||this._next(t)},n.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},n.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},n.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this),this.destination=null)},n.prototype._next=function(t){this.destination.next(t)},n.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},n.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},n}(g),_=Function.prototype.bind;function T(t,e){return _.call(t,e)}var x=function(){function t(t){this.partialObserver=t}return t.prototype.next=function(t){var e=this.partialObserver;if(e.next)try{e.next(t)}catch(t){O(t)}},t.prototype.error=function(t){var e=this.partialObserver;if(e.error)try{e.error(t)}catch(t){O(t)}else O(t)},t.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(t){O(t)}},t}(),k=function(t){function n(e,n,r){var i,o,s=t.call(this)||this;h(e)||!e?i={next:null!=e?e:void 0,error:null!=n?n:void 0,complete:null!=r?r:void 0}:s&&m.useDeprecatedNextContext?((o=Object.create(e)).unsubscribe=function(){return s.unsubscribe()},i={next:e.next&&T(e.next,o),error:e.error&&T(e.error,o),complete:e.complete&&T(e.complete,o)}):i=e;return s.destination=new x(i),s}return e(n,t),n}($);function O(t){E(t)}var R={closed:!0,next:A,error:function(t){throw t},complete:A},I="function"==typeof Symbol&&Symbol.observable||"@@observable";function N(t){return t}var C=function(){function t(t){t&&(this._subscribe=t)}return t.prototype.lift=function(e){var n=new t;return n.source=this,n.operator=e,n},t.prototype.subscribe=function(t,e,n){var r,i=this,o=(r=t)&&r instanceof $||function(t){return t&&h(t.next)&&h(t.error)&&h(t.complete)}(r)&&v(r)?t:new k(t,e,n);return S((function(){var t=i,e=t.operator,n=t.source;o.add(e?e.call(o,n):n?i._subscribe(o):i._trySubscribe(o))})),o},t.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){t.error(e)}},t.prototype.forEach=function(t,e){var n=this;return new(e=U(e))((function(e,r){var i=new k({next:function(e){try{t(e)}catch(t){r(t),i.unsubscribe()}},error:r,complete:e});n.subscribe(i)}))},t.prototype._subscribe=function(t){var e;return null===(e=this.source)||void 0===e?void 0:e.subscribe(t)},t.prototype[I]=function(){return this},t.prototype.pipe=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return(0===(t=e).length?N:1===t.length?t[0]:function(e){return t.reduce((function(t,e){return e(t)}),e)})(this)},t.prototype.toPromise=function(t){var e=this;return new(t=U(t))((function(t,n){var r;e.subscribe((function(t){return r=t}),(function(t){return n(t)}),(function(){return t(r)}))}))},t.create=function(e){return new t(e)},t}();function U(t){var e;return null!==(e=null!=t?t:m.Promise)&&void 0!==e?e:Promise}function P(t){return function(e){if(function(t){return h(null==t?void 0:t.lift)}(e))return e.lift((function(e){try{return t(e,this)}catch(t){this.error(t)}}));throw new TypeError("Unable to lift unknown Observable type")}}function D(t,e,n,r,i){return new L(t,e,n,r,i)}var L=function(t){function n(e,n,r,i,o,s){var a=t.call(this,e)||this;return a.onFinalize=o,a.shouldUnsubscribe=s,a._next=n?function(t){try{n(t)}catch(t){e.error(t)}}:t.prototype._next,a._error=i?function(t){try{i(t)}catch(t){e.error(t)}finally{this.unsubscribe()}}:t.prototype._error,a._complete=r?function(){try{r()}catch(t){e.error(t)}finally{this.unsubscribe()}}:t.prototype._complete,a}return e(n,t),n.prototype.unsubscribe=function(){var e;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;t.prototype.unsubscribe.call(this),!n&&(null===(e=this.onFinalize)||void 0===e||e.call(this))}},n}($),z=d((function(t){return function(){t(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}})),j=function(t){function n(){var e=t.call(this)||this;return e.closed=!1,e.currentObservers=null,e.observers=[],e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return e(n,t),n.prototype.lift=function(t){var e=new F(this,this);return e.operator=t,e},n.prototype._throwIfClosed=function(){if(this.closed)throw new z},n.prototype.next=function(t){var e=this;S((function(){var n,r;if(e._throwIfClosed(),!e.isStopped){e.currentObservers||(e.currentObservers=Array.from(e.observers));try{for(var i=o(e.currentObservers),s=i.next();!s.done;s=i.next()){s.value.next(t)}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}}}))},n.prototype.error=function(t){var e=this;S((function(){if(e._throwIfClosed(),!e.isStopped){e.hasError=e.isStopped=!0,e.thrownError=t;for(var n=e.observers;n.length;)n.shift().error(t)}}))},n.prototype.complete=function(){var t=this;S((function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var e=t.observers;e.length;)e.shift().complete()}}))},n.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(n.prototype,"observed",{get:function(){var t;return(null===(t=this.observers)||void 0===t?void 0:t.length)>0},enumerable:!1,configurable:!0}),n.prototype._trySubscribe=function(e){return this._throwIfClosed(),t.prototype._trySubscribe.call(this,e)},n.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},n.prototype._innerSubscribe=function(t){var e=this,n=this,r=n.hasError,i=n.isStopped,o=n.observers;return r||i?b:(this.currentObservers=null,o.push(t),new g((function(){e.currentObservers=null,f(o,t)})))},n.prototype._checkFinalizedStatuses=function(t){var e=this,n=e.hasError,r=e.thrownError,i=e.isStopped;n?t.error(r):i&&t.complete()},n.prototype.asObservable=function(){var t=new C;return t.source=this,t},n.create=function(t,e){return new F(t,e)},n}(C),F=function(t){function n(e,n){var r=t.call(this)||this;return r.destination=e,r.source=n,r}return e(n,t),n.prototype.next=function(t){var e,n;null===(n=null===(e=this.destination)||void 0===e?void 0:e.next)||void 0===n||n.call(e,t)},n.prototype.error=function(t){var e,n;null===(n=null===(e=this.destination)||void 0===e?void 0:e.error)||void 0===n||n.call(e,t)},n.prototype.complete=function(){var t,e;null===(e=null===(t=this.destination)||void 0===t?void 0:t.complete)||void 0===e||e.call(t)},n.prototype._subscribe=function(t){var e,n;return null!==(n=null===(e=this.source)||void 0===e?void 0:e.subscribe(t))&&void 0!==n?n:b},n}(j),B={now:function(){return(B.delegate||Date).now()},delegate:void 0},H=function(t){function n(e,n,r){void 0===e&&(e=1/0),void 0===n&&(n=1/0),void 0===r&&(r=B);var i=t.call(this)||this;return i._bufferSize=e,i._windowTime=n,i._timestampProvider=r,i._buffer=[],i._infiniteTimeWindow=!0,i._infiniteTimeWindow=n===1/0,i._bufferSize=Math.max(1,e),i._windowTime=Math.max(1,n),i}return e(n,t),n.prototype.next=function(e){var n=this,r=n.isStopped,i=n._buffer,o=n._infiniteTimeWindow,s=n._timestampProvider,a=n._windowTime;r||(i.push(e),!o&&i.push(s.now()+a)),this._trimBuffer(),t.prototype.next.call(this,e)},n.prototype._subscribe=function(t){this._throwIfClosed(),this._trimBuffer();for(var e=this._innerSubscribe(t),n=this._infiniteTimeWindow,r=this._buffer.slice(),i=0;i<r.length&&!t.closed;i+=n?1:2)t.next(r[i]);return this._checkFinalizedStatuses(t),e},n.prototype._trimBuffer=function(){var t=this,e=t._bufferSize,n=t._timestampProvider,r=t._buffer,i=t._infiniteTimeWindow,o=(i?1:2)*e;if(e<1/0&&o<r.length&&r.splice(0,r.length-o),!i){for(var s=n.now(),a=0,u=1;u<r.length&&r[u]<=s;u+=2)a=u;a&&r.splice(0,a+1)}},n}(j),K=function(t){function n(e,n){return t.call(this)||this}return e(n,t),n.prototype.schedule=function(t,e){return this},n}(g),G=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return setInterval.apply(void 0,a([t,e],s(n)))},W=function(t){return clearInterval(t)},M=function(t){function n(e,n){var r=t.call(this,e,n)||this;return r.scheduler=e,r.work=n,r.pending=!1,r}return e(n,t),n.prototype.schedule=function(t,e){var n;if(void 0===e&&(e=0),this.closed)return this;this.state=t;var r=this.id,i=this.scheduler;return null!=r&&(this.id=this.recycleAsyncId(i,r,e)),this.pending=!0,this.delay=e,this.id=null!==(n=this.id)&&void 0!==n?n:this.requestAsyncId(i,this.id,e),this},n.prototype.requestAsyncId=function(t,e,n){return void 0===n&&(n=0),G(t.flush.bind(t,this),n)},n.prototype.recycleAsyncId=function(t,e,n){if(void 0===n&&(n=0),null!=n&&this.delay===n&&!1===this.pending)return e;null!=e&&W(e)},n.prototype.execute=function(t,e){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var n=this._execute(t,e);if(n)return n;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},n.prototype._execute=function(t,e){var n,r=!1;try{this.work(t)}catch(t){r=!0,n=t||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),n},n.prototype.unsubscribe=function(){if(!this.closed){var e=this.id,n=this.scheduler,r=n.actions;this.work=this.state=this.scheduler=null,this.pending=!1,f(r,this),null!=e&&(this.id=this.recycleAsyncId(n,e,null)),this.delay=null,t.prototype.unsubscribe.call(this)}},n}(K),q=function(){function t(e,n){void 0===n&&(n=t.now),this.schedulerActionCtor=e,this.now=n}return t.prototype.schedule=function(t,e,n){return void 0===e&&(e=0),new this.schedulerActionCtor(this,t).schedule(n,e)},t.now=B.now,t}(),V=new(function(t){function n(e,n){void 0===n&&(n=q.now);var r=t.call(this,e,n)||this;return r.actions=[],r._active=!1,r}return e(n,t),n.prototype.flush=function(t){var e=this.actions;if(this._active)e.push(t);else{var n;this._active=!0;do{if(n=t.execute(t.state,t.delay))break}while(t=e.shift());if(this._active=!1,n){for(;t=e.shift();)t.unsubscribe();throw n}}},n}(q))(M),J=V,Z=new C((function(t){return t.complete()}));function X(t){return t&&h(t.schedule)}function Y(t){return t[t.length-1]}function Q(t){return X(Y(t))?t.pop():void 0}var tt=function(t){return t&&"number"==typeof t.length&&"function"!=typeof t};function et(t){return h(null==t?void 0:t.then)}function nt(t){return h(t[I])}function rt(t){return Symbol.asyncIterator&&h(null==t?void 0:t[Symbol.asyncIterator])}function it(t){return new TypeError("You provided "+(null!==t&&"object"==typeof t?"an invalid object":"'"+t+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}var ot="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function st(t){return h(null==t?void 0:t[ot])}function at(t){return c(this,arguments,(function(){var e,n,r;return i(this,(function(i){switch(i.label){case 0:e=t.getReader(),i.label=1;case 1:i.trys.push([1,,9,10]),i.label=2;case 2:return[4,u(e.read())];case 3:return n=i.sent(),r=n.value,n.done?[4,u(void 0)]:[3,5];case 4:return[2,i.sent()];case 5:return[4,u(r)];case 6:return[4,i.sent()];case 7:return i.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}}))}))}function ut(t){return h(null==t?void 0:t.getReader)}function ct(t){if(t instanceof C)return t;if(null!=t){if(nt(t))return i=t,new C((function(t){var e=i[I]();if(h(e.subscribe))return e.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")}));if(tt(t))return r=t,new C((function(t){for(var e=0;e<r.length&&!t.closed;e++)t.next(r[e]);t.complete()}));if(et(t))return n=t,new C((function(t){n.then((function(e){t.closed||(t.next(e),t.complete())}),(function(e){return t.error(e)})).then(null,E)}));if(rt(t))return lt(t);if(st(t))return e=t,new C((function(t){var n,r;try{for(var i=o(e),s=i.next();!s.done;s=i.next()){var a=s.value;if(t.next(a),t.closed)return}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}t.complete()}));if(ut(t))return lt(at(t))}var e,n,r,i;throw it(t)}function lt(t){return new C((function(e){(function(t,e){var n,o,s,a;return r(this,void 0,void 0,(function(){var r,u;return i(this,(function(i){switch(i.label){case 0:i.trys.push([0,5,6,11]),n=l(t),i.label=1;case 1:return[4,n.next()];case 2:if((o=i.sent()).done)return[3,4];if(r=o.value,e.next(r),e.closed)return[2];i.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return u=i.sent(),s={error:u},[3,11];case 6:return i.trys.push([6,,9,10]),o&&!o.done&&(a=n.return)?[4,a.call(n)]:[3,8];case 7:i.sent(),i.label=8;case 8:return[3,10];case 9:if(s)throw s.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}}))}))})(t,e).catch((function(t){return e.error(t)}))}))}function ht(t,e,n,r,i){void 0===r&&(r=0),void 0===i&&(i=!1);var o=e.schedule((function(){n(),i?t.add(this.schedule(null,r)):this.unsubscribe()}),r);if(t.add(o),!i)return o}function dt(t,e){return void 0===e&&(e=0),P((function(n,r){n.subscribe(D(r,(function(n){return ht(r,t,(function(){return r.next(n)}),e)}),(function(){return ht(r,t,(function(){return r.complete()}),e)}),(function(n){return ht(r,t,(function(){return r.error(n)}),e)})))}))}function pt(t,e){return void 0===e&&(e=0),P((function(n,r){r.add(t.schedule((function(){return n.subscribe(r)}),e))}))}function ft(t,e){if(!t)throw new Error("Iterable cannot be null");return new C((function(n){ht(n,e,(function(){var r=t[Symbol.asyncIterator]();ht(n,e,(function(){r.next().then((function(t){t.done?n.complete():n.next(t.value)}))}),0,!0)}))}))}function gt(t,e){if(null!=t){if(nt(t))return function(t,e){return ct(t).pipe(pt(e),dt(e))}(t,e);if(tt(t))return function(t,e){return new C((function(n){var r=0;return e.schedule((function(){r===t.length?n.complete():(n.next(t[r++]),n.closed||this.schedule())}))}))}(t,e);if(et(t))return function(t,e){return ct(t).pipe(pt(e),dt(e))}(t,e);if(rt(t))return ft(t,e);if(st(t))return function(t,e){return new C((function(n){var r;return ht(n,e,(function(){r=t[ot](),ht(n,e,(function(){var t,e,i;try{e=(t=r.next()).value,i=t.done}catch(t){return void n.error(t)}i?n.complete():n.next(e)}),0,!0)})),function(){return h(null==r?void 0:r.return)&&r.return()}}))}(t,e);if(ut(t))return function(t,e){return ft(at(t),e)}(t,e)}throw it(t)}function bt(t,e){return e?gt(t,e):ct(t)}function vt(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return bt(t,Q(t))}function yt(t,e){var n=h(t)?t:function(){return t},r=function(t){return t.error(n())};return new C(e?function(t){return e.schedule(r,0,t)}:r)}var mt=d((function(t){return function(){t(this),this.name="EmptyError",this.message="no elements in sequence"}}));function wt(t,e){return P((function(n,r){var i=0;n.subscribe(D(r,(function(n){r.next(t.call(e,n,i++))})))}))}var Et=Array.isArray;function At(t){return wt((function(e){return function(t,e){return Et(e)?t.apply(void 0,a([],s(e))):t(e)}(t,e)}))}var St=Array.isArray,$t=Object.getPrototypeOf,_t=Object.prototype,Tt=Object.keys;function xt(t){if(1===t.length){var e=t[0];if(St(e))return{args:e,keys:null};if((r=e)&&"object"==typeof r&&$t(r)===_t){var n=Tt(e);return{args:n.map((function(t){return e[t]})),keys:n}}}var r;return{args:t,keys:null}}function kt(t,e,n){return void 0===n&&(n=1/0),h(e)?kt((function(n,r){return wt((function(t,i){return e(n,t,r,i)}))(ct(t(n,r)))}),n):("number"==typeof e&&(n=e),P((function(e,r){return function(t,e,n,r,i,o,s,a){var u=[],c=0,l=0,h=!1,d=function(){!h||u.length||c||e.complete()},p=function(t){return c<r?f(t):u.push(t)},f=function(t){o&&e.next(t),c++;var a=!1;ct(n(t,l++)).subscribe(D(e,(function(t){null==i||i(t),o?p(t):e.next(t)}),(function(){a=!0}),void 0,(function(){if(a)try{c--;for(var t=function(){var t=u.shift();s?ht(e,s,(function(){return f(t)})):f(t)};u.length&&c<r;)t();d()}catch(t){e.error(t)}})))};return t.subscribe(D(e,p,(function(){h=!0,d()}))),function(){null==a||a()}}(e,r,t,n)})))}function Ot(t){return void 0===t&&(t=1/0),kt(N,t)}function Rt(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return Ot(1)(bt(t,Q(t)))}function It(t){return new C((function(e){ct(t()).subscribe(e)}))}function Nt(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=function(t){return h(Y(t))?t.pop():void 0}(t),r=xt(t),i=r.args,o=r.keys,s=new C((function(t){var e=i.length;if(e)for(var n=new Array(e),r=e,s=e,a=function(e){var a=!1;ct(i[e]).subscribe(D(t,(function(t){a||(a=!0,s--),n[e]=t}),(function(){return r--}),void 0,(function(){r&&a||(s||t.next(o?function(t,e){return t.reduce((function(t,n,r){return t[n]=e[r],t}),{})}(o,n):n),t.complete())})))},u=0;u<e;u++)a(u);else t.complete()}));return n?s.pipe(At(n)):s}function Ct(t,e,n){void 0===t&&(t=0),void 0===n&&(n=J);var r=-1;return null!=e&&(X(e)?n=e:r=e),new C((function(e){var i,o=(i=t)instanceof Date&&!isNaN(i)?+t-n.now():t;o<0&&(o=0);var s=0;return n.schedule((function(){e.closed||(e.next(s++),0<=r?this.schedule(void 0,r):e.complete())}),o)}))}function Ut(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Q(t),r=function(t,e){return"number"==typeof Y(t)?t.pop():e}(t,1/0),i=t;return i.length?1===i.length?ct(i[0]):Ot(r)(bt(i,n)):Z}function Pt(t,e){return P((function(n,r){var i=0;n.subscribe(D(r,(function(n){return t.call(e,n,i++)&&r.next(n)})))}))}function Dt(t){return P((function(e,n){var r,i=null,o=!1;i=e.subscribe(D(n,void 0,void 0,(function(s){r=ct(t(s,Dt(t)(e))),i?(i.unsubscribe(),i=null,r.subscribe(n)):o=!0}))),o&&(i.unsubscribe(),i=null,r.subscribe(n))}))}function Lt(t,e){return h(e)?kt(t,e,1):kt(t,1)}function zt(t){return t<=0?function(){return Z}:P((function(e,n){var r=0;e.subscribe(D(n,(function(e){++r<=t&&(n.next(e),t<=r&&n.complete())})))}))}function jt(t,e){return e?function(n){return Rt(e.pipe(zt(1),P((function(t,e){t.subscribe(D(e,A))}))),n.pipe(jt(t)))}:kt((function(e,n){return ct(t(e,n)).pipe(zt(1),function(t){return wt((function(){return t}))}(e))}))}function Ft(t){var e;void 0===t&&(t=1/0);var n=(e=t&&"object"==typeof t?t:{count:t}).count,r=void 0===n?1/0:n,i=e.delay,o=e.resetOnSuccess,s=void 0!==o&&o;return r<=0?N:P((function(t,e){var n,o=0,a=function(){var u=!1;n=t.subscribe(D(e,(function(t){s&&(o=0),e.next(t)}),void 0,(function(t){if(o++<r){var s=function(){n?(n.unsubscribe(),n=null,a()):u=!0};if(null!=i){var c="number"==typeof i?Ct(i):ct(i(t,o)),l=D(e,(function(){l.unsubscribe(),s()}),(function(){e.complete()}));c.subscribe(l)}else s()}else e.error(t)}))),u&&(n.unsubscribe(),n=null,a())};a()}))}function Bt(t,e){return P((function(n,r){var i=null,o=0,s=!1,a=function(){return s&&!i&&r.complete()};n.subscribe(D(r,(function(n){null==i||i.unsubscribe();var s=0,u=o++;ct(t(n,u)).subscribe(i=D(r,(function(t){return r.next(e?e(n,t,u,s++):t)}),(function(){i=null,a()})))}),(function(){s=!0,a()})))}))}function Ht(t,e,n){var r=h(t)||e||n?{next:t,error:e,complete:n}:t;return r?P((function(t,e){var n;null===(n=r.subscribe)||void 0===n||n.call(r);var i=!0;t.subscribe(D(e,(function(t){var n;null===(n=r.next)||void 0===n||n.call(r,t),e.next(t)}),(function(){var t;i=!1,null===(t=r.complete)||void 0===t||t.call(r),e.complete()}),(function(t){var n;i=!1,null===(n=r.error)||void 0===n||n.call(r,t),e.error(t)}),(function(){var t,e;i&&(null===(t=r.unsubscribe)||void 0===t||t.call(r)),null===(e=r.finalize)||void 0===e||e.call(r)})))})):N}function Kt(t,e){void 0===e&&(e={});var r=e.selector,i=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(t,r[i])&&(n[r[i]]=t[r[i]])}return n}(e,["selector"]);return new C((function(e){var o=new AbortController,s=o.signal,a=!0,u=i.signal;if(u)if(u.aborted)o.abort();else{var c=function(){s.aborted||o.abort()};u.addEventListener("abort",c),e.add((function(){return u.removeEventListener("abort",c)}))}var l=n(n({},i),{signal:s}),h=function(t){a=!1,e.error(t)};return fetch(t,l).then((function(t){r?ct(r(t)).subscribe(D(e,void 0,(function(){a=!1,e.complete()}),h)):(a=!1,e.next(t),e.complete())})).catch(h),function(){a&&o.abort()}}))}class Gt{token;constructor(t){this.token=t}urlBase64Decode(t){let e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("Illegal base64url string!")}return this.b64DecodeUnicode(e)}b64decode(t){let e="";if((t=String(t).replace(/=+$/,"")).length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let n,r,i=0,o=0;r=t.charAt(o++);~r&&(n=i%4?64*n+r:r,i++%4)?e+=String.fromCharCode(255&n>>(-2*i&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return e}b64DecodeUnicode(t){return decodeURIComponent(Array.prototype.map.call(this.b64decode(t),(t=>"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2))).join(""))}decodeToken(t=this.token){if(null===t)return null;const e=t.split(".");if(3!==e.length)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");const n=this.urlBase64Decode(e[1]);if(!n)throw new Error("Cannot decode the token.");return JSON.parse(n)}getJWTUser(t=this.token){let e;try{e=this.decodeToken(t)}catch(t){return null}return e}getTokenExpirationDate(t=this.token){const e=this.getJWTUser(t);if(!e||!e.exp)return null;const n=new Date(0);return n.setUTCSeconds(e.exp),n}isTokenExpired(t=this.token,e){if(null===t||""===t)return!0;const n=this.getTokenExpirationDate(t);return e=e||0,null===n||n.valueOf()<=(new Date).valueOf()+1e3*e}}const Wt="JWT_KEY",Mt="JWT_REFRESH_KEY",qt=216e5;class Vt{nuclia;_isAuthenticated=new H(1);timerSubscription;constructor(t){this.nuclia=t,this.nuclia.options.knowledgeBox?this._isAuthenticated.next(!0):this.checkTokenExpiration()}getAuthHeaders(t,e){return this.nuclia.options.standalone?{"X-NUCLIADB-ROLES":this.getNucliaDbRole(t,e)}:this.nuclia.options.apiKey?{"X-NUCLIA-SERVICEACCOUNT":`Bearer ${this.nuclia.options.apiKey}`}:this.getToken()?{Authorization:`Bearer ${this.getToken()}`}:{}}getNucliaDbRole(t,e){let n;switch(t){case"PUT":case"PATCH":case"POST":case"DELETE":n="WRITER";break;default:n="READER"}return"/kbs"===e||("PATCH"===t||"DELETE"===t)&&e?.startsWith("/kb")&&3===e?.split("/").length?n="MANAGER":(e?.endsWith("/search")||e?.endsWith("/find")||e?.endsWith("/catalog")||e?.endsWith("/chat"))&&(n="READER"),n}isAuthenticated(){return this._isAuthenticated.asObservable()}hasLoggedOut(){return this.isAuthenticated().pipe((t=1,Pt((function(e,n){return t<=n}))),Pt((t=>!t)));var t}login(t,e,n){return this.fetch("/auth/login",{username:t,password:e},!1,n?{"X-STF-VALIDATION":n}:{}).pipe(wt((t=>this.authenticate(t))))}authenticate(t){return t.access_token?(this.storeTokens(t),this._isAuthenticated.next(!0),!0):(this._isAuthenticated.next(!1),!1)}logout(){this.fetch("/auth/logout",{},!0,{}).subscribe(),localStorage.removeItem(Wt),localStorage.removeItem(Mt),this._isAuthenticated.next(!1)}refresh(){return this.fetch("/auth/refresh",{refresh_token:this.getRefreshToken()},!0,{}).pipe(Dt((t=>(this.logout(),yt(t)))),wt((t=>t.access_token?(this.storeTokens(t),!0):(this.logout(),!1))))}getToken(t){if(t)return localStorage.getItem(Wt)||"";let e="";try{e=this.nuclia.options.public?"":localStorage.getItem(Wt)||""}catch(t){}return e}setPassword(t){return this.fetch("/auth/setpassword",{password:t},!0,{}).pipe(wt((t=>this.authenticate(t))))}deleteAuthenticatedUser(){return this.nuclia.rest.delete("/user").pipe(Ht((()=>this.storeTokens({access_token:"",refresh_token:""}))))}getJWTUser(){const t=this.getToken();if(t){return new Gt(t).getJWTUser()}return null}getRefreshToken(){return localStorage.getItem(Mt)||""}storeTokens(t){localStorage.setItem(Wt,t.access_token),localStorage.setItem(Mt,t.refresh_token),this.checkTokenExpiration()}checkTokenExpiration(){const t=this.getToken();if(t){const e=new Gt(t),n=e.getTokenExpirationDate()?.getTime(),r=(new Date).getTime();if(n&&n<r)this.logout();else{this._isAuthenticated.next(!0);const t=n&&n-r<qt?0:qt;this.timerSubscription?.unsubscribe(),this.timerSubscription=Ct(t).pipe(Bt((()=>this.refresh()))).subscribe()}}else this._isAuthenticated.next(!1)}fetch(t,e,n,r){const i={"content-type":"application/json",...r};return n&&(i.Authorization=`Bearer ${this.getToken()}`),Kt(`${this.nuclia.backend}${t}`,{method:"POST",selector:t=>Promise.resolve(t),headers:i,body:JSON.stringify(e)}).pipe(Bt((t=>t.ok?bt(t.clone().json()):yt((()=>t)))))}}const Jt="NUCLIA_NUA_KEY";var Zt,Xt,Yt,Qt,te;function ee(t){return Object.values(t).forEach((t=>{t.schemas?.title&&t.schemas?.type&&(t.schema=t.schemas,t.schemas=void 0)})),t}!function(t){t.UNBLOCKED="unblocked",t.QUOTA="quota",t.MANAGER="manager"}(Zt||(Zt={})),function(t){t.UPLOAD="upload",t.PROCESSING="processing",t.SEARCH="search",t.GENERATIVE="generative",t.TRAINING="training",t.PUBLIC_UPLOAD="public_upload",t.PUBLIC_PROCESSING="public_processing",t.PUBLIC_SEARCH="public_search",t.PUBLIC_GENERATIVE="public_generative"}(Xt||(Xt={})),function(t){t.DAY="day",t.WEEK="week",t.MONTH="month",t.YEAR="year"}(Yt||(Yt={})),function(t){t.anHour="1h",t.twoHours="2h",t.threeHours="3h",t.sixHours="6h",t.twelveHours="12h",t.twentyFourHours="24h",t.fortyHeightHours="48h"}(Qt||(Qt={})),function(t){t.PROCESSING_TIME="processing_time",t.SEARCHES="searches",t.CHARS="chars",t.MEDIA_SECONDS="media_seconds",t.BYTES="bytes",t.RESOURCES="resources",t.PAGES="pages",t.TRAIN_SECONDS="train_seconds",t.SUGGESTIONS="suggestions",t.DOCS_NO_MEDIA="docs_no_media",t.AI_TOKENS_USED="ai_tokens_used"}(te||(te={}));const ne="user_prompts",re="summary_prompt";var ie;!function(t){t.BASIC="basic",t.ORIGIN="origin",t.RELATIONS="relations",t.VALUES="values",t.EXTRACTED="extracted",t.ERRORS="errors",t.EXTRA="extra",t.SECURITY="security"}(ie||(ie={}));const oe=5242880,se=new RegExp(/[^a-z0-9_-]/g),ae={count:3,delay:t=>{if(429===t.status||t.status>=500&&t.status<=599)return 429===t.status?vt(!0).pipe(function(t,e){void 0===e&&(e=V);var n=Ct(t,e);return jt((function(){return n}))}(1e3)):vt(!0);throw t}},ue=(t,e,n,r,i={})=>(i.contentType||n instanceof ArrayBuffer||(i.contentType="null"!==n?.type?n?.type:void 0),i.filename||n instanceof ArrayBuffer||(i.filename=n?.name),i.lang||n instanceof ArrayBuffer||(i.lang=n.lang),i.md5||n instanceof ArrayBuffer||(i.md5=n.md5),(n instanceof ArrayBuffer?vt(n):bt(n.arrayBuffer())).pipe(Bt((o=>r?le(t,e,o,i,n.payload):ce(t,e,o,i))))),ce=(t,e,n,r)=>{const i={"content-type":r?.contentType||"application/octet-stream",...pe(r)},o=r?.rslug?`?rslug=${r.rslug}`:"";return vt(!0).pipe(Bt((()=>t.rest.post(`${e}/upload${o}`,n,i,!0))),Ft(ae),Bt((t=>{try{switch(t.status){case 201:return bt(t.json()).pipe(wt((t=>({resource:t.uuid||"",field:t.field_id||"",completed:!0}))));case 409:return vt({conflict:!0});default:return vt({failed:!0})}}catch(t){return vt({failed:!0})}})),Dt((()=>vt({failed:!0}))))},le=(t,e,n,r,i)=>{let o=0,s=0,a=!1;const u=n.byteLength,c=Math.ceil(u/oe),l={"upload-length":`${u}`,"tus-resumable":"1.0.0"},h=[];return r?.filename&&h.push(`filename ${btoa(encodeURIComponent(r.filename))}`),r?.lang&&h.push(`language ${btoa(r.lang)}`),r?.md5&&h.push(`md5 ${btoa(r.md5)}`),h.push(`content_type ${btoa(r?.contentType||"application/octet-stream")}`),h.length>0&&(l["upload-metadata"]=h.join(",")),vt(!0).pipe(Bt((()=>t.rest.post(`${e}/tusupload`,i,l,!0))),Ft(ae),Dt((t=>vt(t))),Lt((e=>Ut(vt(e).pipe(Pt((t=>201!==t.status||!t.headers.get("location"))),wt((t=>409===t.status?{conflict:!0,failed:!0}:{failed:!0}))),vt(e).pipe(Pt((t=>201===t.status&&!!t.headers.get("location"))),wt((t=>t.headers.get("location"))),Lt((e=>function(t,e,n){if(null==e&&(e=t,t=0),e<=0)return Z;var r=e+t;return new C(n?function(e){var i=t;return n.schedule((function(){i<r?(e.next(i++),this.schedule()):e.complete()}))}:function(e){for(var n=t;n<r&&!e.closed;)e.next(n++);e.complete()})}(0,c).pipe(Lt((()=>{const i=n.slice(o,o+oe);return s+=1,a?vt({failed:a}):vt(!0).pipe(Bt((()=>t.rest.patch(e,i,{"content-type":r?.contentType||"application/octet-stream","upload-offset":`${o}`,"content-length":`${i.byteLength}`},!0))),Ft(ae),wt((t=>200!==t.status?(a=!0,{failed:a}):(o+=oe,{completed:s===c,progress:o>=u?100:Math.min(Math.floor(o/u*100),100)}))),Dt((()=>(a=!0,vt({failed:!0})))))}))))))))))},he=(t,e,n,r=!1)=>{const i=Array.from(n),o=i.reduce(((t,e)=>t+(e.size||0)),0),s=[],a=i.map((t=>({file:t,progress:0,uploaded:!1,failed:!1})));return bt(i.map((n=>{let i=e;if(r){let t=n.name.toLowerCase().replace(se,"_");s.includes(t)&&(t+="_"+s.filter((e=>e.startsWith(t))).length),s.push(t),i=`${i}/file/${t}`}const o=n.lang;if(o){const t=n.payload||{};n.payload={...t,metadata:{...t?.metadata,language:o}}}return ue(t,i,n,!0,{}).pipe(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Q(t);return P((function(e,r){(n?Rt(t,e,n):Rt(t,e)).subscribe(r)}))}({progress:0,completed:!1}),wt((t=>({status:t,file:n}))))}))).pipe(kt((t=>t),6),wt((t=>{const e=a.find((e=>e.file===t.file));t.status.failed&&(e.failed=!0),t.status.conflict&&(e.conflicts=!0),t.status.completed&&(e.uploaded=!0),t.status.failed||t.status.conflict||t.status.completed?e.progress=100:e.progress=t.status.progress||0;const n=a.filter((t=>t.failed)).length,r=a.filter((t=>t.conflicts)).length,i=a.filter((t=>t.uploaded)).length,s=0===a.filter((t=>!t.failed&&!t.uploaded)).length,u=Math.round(a.reduce(((t,e)=>t+e.file.size*e.progress/100),0)/o*100);return{files:a,progress:u,completed:s,uploaded:i,failed:n,conflicts:r}})))},de=(t,e,n,r)=>{const i={"x-nuclia-nuakey":`Bearer ${e}`,"content-type":r?.contentType||"application/octet-stream",...pe(r)};return t.rest.post("/processing/upload",n,i)},pe=t=>{const e={};return t?.filename&&(e["x-filename"]=encodeURIComponent(t.filename)),t?.md5&&(e["x-md5"]=t.md5),t?.lang&&(e["x-language"]=t.lang),e};var fe,ge,be,ve;!function(t){t.text="text",t.file="file",t.link="link",t.layout="layout",t.conversation="conversation",t.keywordset="keywordset",t.datetime="datetime",t.generic="generic"}(fe||(fe={})),function(t){t.PENDING="PENDING",t.PROCESSED="PROCESSED",t.ERROR="ERROR",t.DELETED="DELETED"}(ge||(ge={}));class ye{value;extracted;error}class me{value;extracted;error}class we{value;extracted;error}class Ee{value;extracted;error}class Ae{value;extracted;error}!function(t){t.VALUE="value",t.EXTRACTED="extracted",t.ERROR="error"}(be||(be={})),function(t){t.TEXT="text",t.METADATA="metadata",t.SHORTENED_METADATA="shortened_metadata",t.LARGE_METADATA="large_metadata",t.VECTOR="vectors",t.LINK="link",t.FILE="file"}(ve||(ve={}));const Se="classification.labels",$e="entities";function _e(t){return`/${Se}/${t.labelset}/${t.label}`}function Te(t){const e=t.split("/");return{labelset:e[2],label:e[3]}}function xe(t){return`/${Se}/${t}`}function ke(t){return t.split("/")[2]}function Oe(t){return`/${$e}/${t.family}/${t.entity}`}function Re(t){const e=t.split("/");return{family:e[2],entity:e[3]}}var Ie,Ne,Ce,Ue;!function(t){t.created="created",t.modified="modified",t.title="title"}(Ie||(Ie={})),function(t){t.all="all",t.any="any",t.none="none",t.not_all="not_all"}(Ne||(Ne={})),function(t){t.layout="l",t.text="t",t.file="f",t.link="u",t.datetime="d",t.keywordset="k",t.generic="a",t.conversation="c"}(Ce||(Ce={})),function(t){var e,n,r,i;(e=t.Features||(t.Features={})).PARAGRAPH="paragraph",e.DOCUMENT="document",e.RELATIONS="relations",e.VECTOR="vector",(n=t.ResourceFeatures||(t.ResourceFeatures={})).PARAGRAPH="paragraph",n.RELATIONS="relations",n.VECTOR="vector",(r=t.SuggestionFeatures||(t.SuggestionFeatures={})).PARAGRAPH="paragraph",r.ENTITIES="entities",r.INTENT="intent",(i=t.FindScoreType||(t.FindScoreType={})).VECTOR="VECTOR",i.BM25="BM25",i.BOTH="BOTH"}(Ue||(Ue={}));const Pe=(t,e,n,r,i=[],o,s)=>{const{inTitleOnly:a,...u}=o||{};o?.with_synonyms&&(i.includes(Ue.Features.VECTOR)||i.includes(Ue.Features.RELATIONS))&&(console.warn("with_synonyms option cannot work with VECTOR and RELATIONS features"),i=i.filter((t=>t===Ue.Features.PARAGRAPH||t===Ue.Features.DOCUMENT)));const c={query:r||"",features:i};a&&(c.fields=["a/title"]),c.shards=t.currentShards?.[e]||[];const l=`${n}/find`;return(s?t.rest.get(`${l}?${Fe(c,u)}`,void 0,!0):t.rest.post(l,{...c,...u},void 0,!0)).pipe(Bt((e=>{const n=e.headers.get("X-Nuclia-Trace-Id")||"";return e.ok&&206!==e.status?bt(e.json().then((t=>({...t,searchId:n})),(()=>{console.warn(`${l} did not return a valid JSON`)}))):(206===e.status&&t.events?.emit("partial",{...c,...u}),bt(e.json().then((t=>{throw{status:e.status,body:t}}),(()=>{throw{status:e.status}}))))})),Dt((t=>vt({type:"error",status:t.status,detail:t.detail,body:t.body}))),wt((t=>"error"===t.type?t:{...t,type:"findResults"})),Ht((n=>{"findResults"===n.type&&n.shards&&(t.currentShards={...t.currentShards,[e]:n.shards})})))},De=(t,e,n,r,i=[],o,s)=>{const{inTitleOnly:a,...u}=o||{},c={query:r||"",features:i};a&&(c.fields=["a/title"]),c.shards=t.currentShards?.[e]||[];const l=s?t.rest.get(`${n}/search?${Fe(c,u)}`):t.rest.post(`${n}/search`,{...c,...u});return je(t,e,l)},Le=(t,e,n,r,i)=>{const o={};o.query=n||"",o.shards=t.currentShards?.[e]||[];const s=`/kb/${e}`,a=i?t.rest.get(`${s}/catalog?${r?Fe(o,r):""}`):t.rest.post(`${s}/catalog`,{...o,...r});return je(t,e,a)},ze=(t,e,n,r,i,o)=>{const s={query:r||"",features:o};return i&&(s.fields=["a/title"]),t.rest.get(`${n}/suggest?${Fe(s,{})}`).pipe(Dt((t=>vt({type:"error",status:t.status,detail:t.detail}))),wt((t=>"error"===t.type?t:{...t,type:"suggestions"})))};function je(t,e,n){return n.pipe(Dt((t=>vt({type:"error",status:t.status,detail:t.detail}))),wt((t=>"error"===t.type?t:{...t,type:"searchResults"})),Ht((n=>{"searchResults"===n.type&&n.shards&&(t.currentShards={...t.currentShards,[e]:n.shards})})))}const Fe=(t,e)=>{Object.entries(e||{}).forEach((([e,n])=>{null!=n&&(Array.isArray(n)?t[e]=n.map((t=>`${t}`)):"object"==typeof n?Object.entries(n).forEach((([n,r])=>t[`${e}_${n}`]=`${r}`)):t[e]=`${n}`)}));const n=new URLSearchParams;return Object.entries(t).forEach((([t,e])=>Array.isArray(e)?e.forEach((e=>n.append(t,e))):n.append(t,e))),n.toString()};var Be;!function(t){var e,n;(e=t.Features||(t.Features={})).PARAGRAPHS="paragraphs",e.RELATIONS="relations",e.VECTORS="vectors",(n=t.Author||(t.Author={})).USER="USER",n.NUCLIA="NUCLIA"}(Be||(Be={}));const He="_END_",Ke="_CIT_";function Ge(t,e,n,r=[],i=[Be.Features.VECTORS,Be.Features.PARAGRAPHS],o={}){let s,a,u,c=0,l="";const{synchronous:h,...d}=o,p=Object.entries(d).reduce(((t,[e,n])=>(null!=n&&""!==n&&(t[e]=n),t)),{}),f=`${e}/chat`,g={query:n,context:r,show:[ie.BASIC,ie.VALUES],features:i.length>0?i:void 0,...p};return h?t.rest.post(f,g,void 0,void 0,!0).pipe(wt((({answer:t,relations:e,results:n,citations:r})=>({type:"answer",text:t,sources:{...n,relations:e},citations:r,incomplete:!1,id:""})))):t.rest.getStreamedResponse(f,g).pipe(wt((({data:t,incomplete:e,headers:n})=>{const r=n.get("X-Nuclia-Trace-Id")||"",i=n.get("NUCLIA-LEARNING-ID")||"";if(0===c&&t.length>=4&&(c=new DataView(t.buffer.slice(0,4)).getUint32(0)),!s&&c>0&&t.length>c+4){const e=t.slice(4,c+4);s=JSON.parse(atob((new TextDecoder).decode(e.buffer)))}if(s&&(s.searchId=r),s&&t.length>c+4&&(l=(new TextDecoder).decode(t.slice(c+4).buffer),l.includes(He))){let t;if([l,t]=l.split(He),l.includes(Ke)){let t;[l,t]=l.split(Ke);const e=t.slice(4);try{u=JSON.parse(atob(e))}catch(t){console.warn(t)}}if(t)try{a=JSON.parse(atob(t)),s.relations=a}catch(t){console.warn(t)}}return{type:"answer",text:l,sources:s,incomplete:e,id:i,citations:u}})),Dt((t=>vt({type:"error",status:t.status,detail:t.detail||""}))))}const We=t=>[...new Set([...t].map((t=>JSON.stringify(t))))].map((t=>JSON.parse(t))),Me=(t,e,n,r,i)=>{const o=We(i.filter((n=>Ve(n,t,e))).map((t=>t.token)).reduce(((t,e)=>t.concat(e)),[])),s=We(i.filter((n=>Je(n,t,e))).map((t=>t.paragraphs)).reduce(((t,e)=>t.concat(e)),[])).filter((t=>t.key!==n)),a=i.filter((n=>n.field.field!==t||n.field.field_type!==e)),u=r.length>0?[...s,{key:n,classifications:r}]:s;return o.length>0||u.length>0?[...a,{field:{field:t,field_type:e},token:o.length>0?o:void 0,paragraphs:u.length>0?u:void 0}]:a},qe=(t,e,n,r)=>{const i=We(r.filter((n=>Je(n,t,e))).map((t=>t.paragraphs)).reduce(((t,e)=>t.concat(e)),[])),o=r.filter((n=>n.field.field!==t||n.field.field_type!==e));return n.length>0||i.length>0?[...o,{field:{field:t,field_type:e},token:n.length>0?n:void 0,paragraphs:i.length>0?i:void 0}]:o},Ve=(t,e,n)=>t.field.field===e&&t.field.field_type===n&&t.token&&t.token.length>0,Je=(t,e,n)=>t.field.field===e&&t.field.field_type===n&&t.paragraphs&&t.paragraphs.length>0,Ze=(t,e,n)=>t?(Array.isArray(t)||(t=Array.from(t)),t.slice(e,n).join("")):"",Xe=t=>t?Array.from(t).length:0;class Ye{data={};fieldTextsCache={};constructor(t){t.data||(t.data={}),Object.assign(this,{...t,title:this.formatTitle(t.title)})}getFields(t=["files","links","texts","keywordsets"]){return Object.entries(this.data).filter((([e])=>t.includes(e))).map((([,t])=>t)).filter((t=>!!t)).map((t=>Object.values(t))).reduce(((t,e)=>t.concat(e)),[])}getFieldData(t,e){const n=this.data[t]?.[e];return n||void 0}getExtractedSummaries(){return this.getFields().filter((t=>t.extracted?.metadata?.metadata?.summary)).map((t=>t.extracted.metadata.metadata.summary))}getExtractedTexts(){return this.getFields().filter((t=>t.extracted?.text)).map((t=>t.extracted.text))}getFiles(){return this.getFields(["files"]).filter((t=>!!t&&!!t.value&&!!t.value.file)).map((t=>t.value.file))}getThumbnails(){return this.getFields(["files"]).map((t=>t.extracted?.file?.file_thumbnail)).concat(this.getFields(["links"]).map((t=>t.extracted?.link?.link_thumbnail))).filter((t=>!!t))}getAnnotatedEntities(){return(this.fieldmetadata||[]).filter((t=>t.token&&t.token.length>0)).map((t=>t.token)).reduce(((t,e)=>(e.filter((t=>!t.cancelled_by_user)).forEach((e=>{t[e.klass]||(t[e.klass]=[]),t[e.klass].push(e.token)})),t)),{})}getNamedEntities(){return this.getFields().filter((t=>t.extracted?.metadata?.metadata?.ner)).map((t=>Object.entries(t.extracted.metadata.metadata.ner).reduce(((t,[e,n])=>(t[n]=(t[n]||[]).concat([e]),t)),{}))).reduce(((t,e)=>(Object.entries(e).forEach((([e,n])=>{t[e]=(t[e]||[]).concat(n)})),t)),{})}getClassifications(){const t=(this.usermetadata?.classifications||[]).filter((t=>!t.cancelled_by_user)),e=(this.usermetadata?.classifications||[]).filter((t=>t.cancelled_by_user));return(this.computedmetadata?.field_classifications||[]).reduce(((t,n)=>(n.classifications.forEach((n=>{const r=t.find((t=>t.label===n.label&&t.labelset===n.labelset)),i=e.find((t=>t.label===n.label&&t.labelset===n.labelset));r||i||t.push({...n,immutable:!0})})),t)),t)}getPositionedNamedEntities(t,e){const n=this.data[t]?.[e]?.extracted?.metadata?.metadata.positions;return n?Object.entries(n).reduce(((t,[e,n])=>{const r=e.split("/")[0];return n.position.forEach((e=>{t.push({entity:n.entity,family:r,...e})})),t}),[]):[]}formatTitle(t){t=t||"–";try{return decodeURIComponent(t)}catch(e){return t}}getParagraphText(t,e,n){return Ze(this.getFieldText(t,e),n.start,n.end)}getSentenceText(t,e,n){return Ze(this.getFieldText(t,e),n.start,n.end)}getFieldText(t,e){const n=`${t}-${e}`;if(!this.fieldTextsCache[n]){const r=this.getFieldData(`${t}s`,e);this.fieldTextsCache[n]=Array.from(r?.extracted?.text?.text||"")}return this.fieldTextsCache[n]}}class Qe extends Ye{kb;uuid;nuclia;get kbPath(){return`/kb/${this.kb}`}get path(){if(!this.uuid&&!this.slug)throw new Error("Resource must have either uuid or slug");return this.uuid?`${this.kbPath}/resource/${this.uuid}`:`${this.kbPath}/slug/${this.slug}`}constructor(t,e,n){super(n),this.nuclia=t,this.kb=e,this.uuid=n.id}modify(t,e=!0){return this.nuclia.rest.patch(this.path,t,void 0,void 0,e)}delete(t=!0){return this.nuclia.rest.delete(this.path,void 0,t)}reprocess(){return this.nuclia.rest.post(`${this.path}/reprocess`,{},void 0,void 0,!0)}getField(t,e,n=[be.VALUE],r=[ve.TEXT,ve.SHORTENED_METADATA,ve.LINK,ve.FILE]){const i=[...n.map((t=>`show=${t}`)),...r.map((t=>`extracted=${t}`))];return this.nuclia.rest.get(`${this.path}/${t}/${e}?${i.join("&")}`)}getThumbnailsUrl(){return Nt(this.getThumbnails().filter((t=>t.uri)).map((t=>this.nuclia.rest.getObjectURL(t.uri))))}deleteField(t,e,n=!1){return this.nuclia.rest.delete(`${this.path}/${t}/${e}`,void 0,n)}setField(t,e,n){return this.nuclia.rest.put(`${this.path}/${t}/${e}`,n)}upload(t,e,n,r){return ue(this.nuclia,`${this.path}/file/${t}`,e,!!n,r)}batchUpload(t){return he(this.nuclia,this.path,t,!0)}search(t,e=[],n){return De(this.nuclia,this.kb,this.path,t,e,n,!0)}find(t,e=[],n){return Pe(this.nuclia,this.kb,this.kbPath,t,e,this.uuid?{...n,resource_filters:[this.uuid]}:n)}setLabels(t,e,n,r){const i=Me(t,e,n,r,this.fieldmetadata||[]);return this.modify({fieldmetadata:i}).pipe(Ht((()=>this.fieldmetadata=i)))}setEntities(t,e,n){const r=qe(t,e,n,this.fieldmetadata||[]);return this.modify({fieldmetadata:r}).pipe(Ht((()=>this.fieldmetadata=r)))}}const tn=(t,e)=>{const n={title:t.title,fullText:t.getExtractedTexts().filter((t=>t)).map((t=>t.text))};t.getClassifications().forEach((t=>{t.labelset&&t.label&&(n[t.labelset]=t.label)}));const r=t.getThumbnails().filter((t=>!!t.uri)).map((t=>`${e}/v1${t.uri}`));return{...n,images:r,...t.getNamedEntities()}},en=t=>{switch(t){case fe.text:case fe.file:case fe.link:case fe.keywordset:return`${t}s`;default:return null}};function nn(t){return Ce[t]}function rn(t){switch(t){case Ce.conversation:return fe.conversation;case Ce.datetime:return fe.datetime;case Ce.file:return fe.file;case Ce.layout:return fe.layout;case Ce.keywordset:return fe.keywordset;case Ce.link:return fe.link;case Ce.text:return fe.text;case Ce.generic:return fe.generic;default:return null}}function on(t){switch(t){case fe.file:return fe.file;case fe.link:return fe.link;case fe.text:return fe.text;case fe.layout:return fe.layout;case fe.conversation:return fe.conversation;case fe.datetime:return fe.datetime;case fe.generic:return fe.generic;default:return null}}var sn,an,un;!function(t){t.classifier="classifier",t.resource_labeler="resource-labeler",t.paragraph_labeler="paragraph-labeler",t.ner="ner"}(sn||(sn={})),function(t){t.finished="finished",t.not_running="not_running",t.running="running",t.started="started",t.stopped="stopped"}(an||(an={})),function(t){t.succeeded="succeeded",t.failed="failed",t.stopped="stopped"}(un||(un={}));class cn{kb;nuclia;constructor(t,e){this.kb=t,this.nuclia=e}start(t,e){return this.nuclia.rest.post(`${this.kb.path}/train/${t}/start`,e||{})}stop(t){return this.nuclia.rest.post(`${this.kb.path}/train/${t}/stop`,{})}getStatus(t){return this.nuclia.rest.get(`${this.kb.path}/train/${t}/inspect`).pipe(Dt((()=>vt({task:"",status:an.not_running}))))}getExecutions(t=0){return this.nuclia.rest.get(`${this.kb.path}/train/executions?page=${t}`)}hasModel(t){return this.nuclia.rest.get(`${this.kb.path}/train/${t}/model/model/nuclia.json`).pipe(wt((()=>!0)),Dt((()=>vt(!1))))}}function ln(t,e,n){return t.rest.getStreamMessages(`${e}/notifications`,n).pipe(wt((({data:t})=>(new TextDecoder).decode(t).split("\n").filter((t=>!!t)).map((t=>JSON.parse(t))))))}const hn="Stop listening to streaming";class dn{nuclia;zones;streamErrorAt;constructor(t){this.nuclia=t}get(t,e,n,r){return this.fetch("GET",t,void 0,e,n,void 0,r)}post(t,e,n,r,i,o){return this.fetch("POST",t,e,n,r,i,o)}put(t,e,n,r,i,o){return this.fetch("PUT",t,e,n,r,i,o)}patch(t,e,n,r,i,o){return this.fetch("PATCH",t,e,n,r,i,o)}delete(t,e,n,r){return this.fetch("DELETE",t,void 0,e,!0,n,r)}head(t,e){return this.fetch("HEAD",t,void 0,e,!0)}getHeaders(t,e,n,r=!1){const i=n&&n["x-nuclia-nuakey"]?{}:this.nuclia.auth.getAuthHeaders(t,e),o={"content-type":"application/json","x-ndb-client":this.nuclia.options.client||"web",...i};r&&(o["x-synchronous"]=`${r}`);const s={...o,...n};return this.nuclia.options.modifyHeaders?this.nuclia.options.modifyHeaders(s):s}fetch(t,e,n,r,i,o=!1,s=undefined,a){const u=r&&r["content-type"]?n:JSON.stringify(n);return bt(fetch(this.getFullUrl(e,s,a),{method:t,headers:this.getHeaders(t,e,r,o),body:u}).then((n=>n.ok?i?n:n.json().then((t=>t),(()=>{console.warn(`${e} did not return a valid JSON`)})):(this.nuclia.events?.emit("api-error",{status:n.status,path:this.getFullUrl(e)}),n.json().then((r=>{const i=`${n.status} error on ${t} ${e}${u?"\nPayload: "+u:""}`;try{console.error(`${i}\n${JSON.stringify(r)}`)}catch(t){console.error(i)}throw{status:n.status,body:r}}),(()=>{throw console.error(`${n.status} error on ${t} ${e}${u?"\nPayload: "+u:""}`),{status:n.status}}))))))}getFullUrl(t,e,n){if(t.includes("/api/authorizer/authorize"))return t;if(t.startsWith("http"))return t;const r=t.startsWith("/account")&&!t.includes("/activity")&&!t.endsWith("/ephemeral_tokens")||t.startsWith("/user")||t.startsWith("/auth")||t.startsWith("/zones")||t.startsWith("/billing")||t.startsWith("/configuration")||t.startsWith("/manage")||t.startsWith("/marketplace");let i;i=!e||this.nuclia.options.standalone||this.nuclia.options.proxy?r||this.nuclia.options.standalone||this.nuclia.options.proxy?this.nuclia.backend:this.nuclia.regionalBackend:`${this.nuclia.backend.replace("https://",`https://${e}.`)}`;return`${i}${n?"/authorizer/authorize/api":""}${t.startsWith("/auth")||t.startsWith("/export")||t.startsWith("/billing")||t.startsWith("/configuration")||t.startsWith("/manage")||t.startsWith("/marketplace")?"":"/v1"}${t}`}checkAuthorization(t){return this.fetch("GET",t,void 0,void 0,!0,!1,void 0,!0).pipe(wt((t=>{const e=t.headers.get("x-nucliadb-roles")||"";return{allowed:t.ok,roles:e.split(";")}})),Dt((()=>vt({allowed:!1,roles:[]}))))}getZones(){return this.zones?vt(this.zones):this.get("/zones").pipe(wt((t=>{const e=t.reduce(((t,e)=>(t[e.id]=e.slug,t)),{});return this.zones=e,e})))}getZoneSlug(t){return this.getZones().pipe(wt((e=>e[t])))}getObjectURL(t){return this.get(t,void 0,!0).pipe(Bt((t=>bt(t.blob()))),wt((t=>URL.createObjectURL(t))))}getStreamedResponse(t,e){return t=this.getFullUrl(t),new C((n=>{fetch(t,{method:"POST",headers:this.getHeaders("POST",t),body:JSON.stringify(e)}).then((e=>{const r=e.body?.getReader(),i=e.headers,o=e.status;if(r&&e.ok){let e=new Uint8Array;const o=()=>{r.read().then((({done:t,value:r})=>{t&&(n.next({data:e,incomplete:!1,headers:i}),n.complete()),r&&(e=this.concat(e,r),n.next({data:e,incomplete:!0,headers:i}),o())}),(e=>{console.error(`getStreamedResponse: read error on POST ${t}`),n.error(e),n.complete()}))};o()}else console.error(`getStreamedResponse: error ${o} on POST ${t}`),n.error({status:o}),n.complete()}),(e=>{const r=`getStreamedResponse: error on POST ${t}`;try{console.error(`${r}\n${JSON.stringify(e)}`)}catch(t){console.error(r)}n.error(e),n.complete()}))}))}getStreamMessages(t,e){return t=this.getFullUrl(t),new C((n=>this.fetchStream(t,n,e)))}fetchStream(t,e,n){fetch(t,{method:"GET",headers:this.getHeaders("GET",t),signal:n.signal}).then((r=>{const i=r.body?.getReader(),o=r.headers,s=r.status;if(i&&r.ok){const r=()=>{i.read().then((({value:i})=>{i?(e.next({data:i,headers:o}),r()):this.fetchStream(t,e,n)}),(t=>{e.error(t),e.complete()}))};r()}else console.error(`getStreamedMessage: error ${s} on GET ${t}`),e.error({status:s}),e.complete()}),(r=>{r===hn?e.complete():"TypeError: NetworkError when attempting to fetch resource."!==r.toString()&&(!this.streamErrorAt||Date.now()-this.streamErrorAt>1e4)?(console.warn(`Message stream lost: "${r}". Reconnecting at ${new Date}`),this.streamErrorAt=Date.now(),this.fetchStream(t,e,n)):(console.error(`getStreamedMessage: error on GET ${t} (stream lost): ${r}`),e.error(`Message stream lost: ${r}`),e.complete())}))}concat(t,e){const n=new Uint8Array(t.length+e.length);return n.set(t),n.set(e,t.length),n}}class pn{accountId;nuclia;tempToken;notifications;notificationsController;resourceProcessingStatus={};resourceOperationStatus={};get path(){return`/kb/${this.id}`}get fullpath(){return`${this.nuclia.regionalBackend}/v1/kb/${this.id}`}constructor(t,e,n){this.nuclia=t,this.accountId=e,Object.assign(this,n),!n.id&&n.uuid&&(this.id=n.uuid),!n.title&&n.slug&&(this.title=n.slug)}getEntities(){return this.nuclia.rest.get(`${this.path}/entitiesgroups`).pipe(wt((t=>t.groups)))}getEntitiesGroup(t){return this.nuclia.rest.get(`${this.path}/entitiesgroup/${t}`)}getSynonyms(){return this.nuclia.rest.get(`${this.path}/custom-synonyms`).pipe(wt((t=>t.synonyms)))}getLabels(){return this.nuclia.rest.get(`${this.path}/labelsets`).pipe(wt((t=>t?.labelsets||{})),Dt((()=>vt({}))))}getResource(t,e=[ie.BASIC,ie.ORIGIN,ie.RELATIONS,ie.VALUES,ie.EXTRACTED,ie.ERRORS],n=[ve.TEXT,ve.METADATA,ve.LINK,ve.FILE]){return this._getResource(t,void 0,e,n)}getResourceBySlug(t,e=[ie.BASIC,ie.ORIGIN,ie.RELATIONS,ie.VALUES,ie.EXTRACTED,ie.ERRORS],n=[ve.TEXT,ve.METADATA,ve.LINK,ve.FILE]){return this._getResource(void 0,t,e,n)}_getResource(t,e,n=[ie.BASIC,ie.ORIGIN,ie.RELATIONS,ie.VALUES,ie.EXTRACTED,ie.ERRORS],r=[ve.TEXT,ve.METADATA,ve.LINK,ve.FILE]){const i=[...n.map((t=>`show=${t}`)),...r.map((t=>`extracted=${t}`))];return this.nuclia.rest.get(`${this._getPath(t,e)}?${i.join("&")}`).pipe(wt((t=>new Qe(this.nuclia,this.id,t))))}_getPath(t,e){return t?`${this.path}/resource/${t}`:`${this.path}/slug/${e}`}getResourceFromData(t){return new Qe(this.nuclia,this.id,t)}chat(t,e,n,r,i){const o=Ge(this.nuclia,this.path,t,e,n,r);return i?(o.subscribe((t=>i(t))),vt(null)):o}find(t,e=[],n){return Pe(this.nuclia,this.id,this.path,t,e,n)}search(t,e=[],n){return De(this.nuclia,this.id,this.path,t,e,n)}summarize(t,e,n){const r=[0,1e3,2e3,5e3,1e4],i={count:r.length,delay:(t,e)=>Ct(r[e-1])};return It((()=>this.nuclia.rest.post(`${this.path}/summarize`,{resources:t,user_prompt:e,generative_model:n}))).pipe(Ft(i),wt((t=>t.summary)))}tokens(t){return this.nuclia.rest.get(`${this.path}/predict/tokens?text=${decodeURIComponent(t)}`).pipe(wt((t=>t.tokens)))}generate(t,e=[]){return this.nuclia.rest.post(`${this.path}/predict/chat`,{question:t,query_context:e,user_id:"USER"},void 0,!0).pipe(Bt((t=>bt(t.text()))),wt((t=>{const e="0"!==t.slice(-1);return{answer:t.slice(0,-1),cannotAnswer:e}})))}rephrase(t){return this.nuclia.rest.post(`${this.path}/predict/rephrase`,{question:t,user_id:"USER"}).pipe(wt((t=>t.slice(0,-1))))}generateRandomQuestionAboutResource(t){const e=t.getFields().filter((t=>!!t.extracted?.metadata));if(0===e.length)return yt((()=>"No field with extracted metadata. Make sure to call `getResource` with `show=extracted` and `extracted=metadata`"));const n=e.find((t=>(t.extracted?.metadata?.metadata.relations?.filter((t=>"entity"===t.from?.type&&"entity"===t.to.type))||[]).length>0));if(n){const t=n.extracted?.metadata?.metadata.relations?.find((t=>"entity"===t.from?.type&&"entity"===t.to.type));return this.rephrase(`${t?.from?.value} ${t?.label} ${t?.to.value}`)}return vt("")}catalog(t,e){return Le(this.nuclia,this.id,t,e)}suggest(t,e=!1,n=[]){return ze(this.nuclia,this.id,this.path,t,e,n)}feedback(t,e){return this.nuclia.rest.post(`${this.path}/feedback`,{ident:t,good:e,task:"CHAT",feedback:""})}listFeedback(){return this.nuclia.rest.get(`${this.path}/feedback`)}counters(){return this.nuclia.rest.get(`/kb/${this.id}/counters`)}listResources(t,e){const n=[t?`page=${t}`:"",e?`size=${e}`:""].filter((t=>t)).join("&");return this.nuclia.rest.get(`/kb/${this.id}/resources${n?"?"+n:""}`).pipe(wt((t=>({resources:t.resources.map((t=>new Qe(this.nuclia,this.id,t))),pagination:t.pagination}))))}getTempToken(){if(this.tempToken&&this.tempToken.expiration>Date.now())return vt(this.tempToken.token);let t;if(this.nuclia.options.standalone)t=this.nuclia.rest.get("/temp-access-token");else{const e=this.nuclia.options.accountId,n=this.nuclia.options.zone;if(!e||!n)throw new Error("Account id and zone are required to get a temp token");t=this.nuclia.rest.post(`/account/${e}/kb/${this.id}/ephemeral_tokens`,{},void 0,void 0,void 0,n)}return t.pipe(wt((t=>t.token)),Ht((t=>this.tempToken={token:t,expiration:Date.now()+3e5})))}listActivity(t,e,n){const r=[t?`type=${t}`:"",e?`page=${e}`:"",n?`size=${n}`:""].filter((t=>t)).join("&");return this.nuclia.rest.get(`/kb/${this.id}/activity${r?"?"+r:""}`)}listActivityDownloads(t){return this.nuclia.rest.get(`/kb/${this.id}/activity/downloads?type=${t}`)}downloadActivity(t,e){return this.nuclia.rest.get(`/kb/${this.id}/activity/download?type=${t}&month=${e}`,{},!0).pipe(Bt((t=>bt(t.blob()))))}getConfiguration(){return this.nuclia.rest.get(`/kb/${this.id}/configuration`)}getLearningSchema(){return this.nuclia.rest.get(`/kb/${this.id}/schema`).pipe(Bt((t=>{const e=ee(t);return this.nuclia.options.standalone?vt(e):this.nuclia.db.getAccount(this.accountId).pipe(wt((t=>"stash-starter"===t.type||"v3starter"===t.type?function(t){return Object.entries(t).reduce(((t,[e,n])=>(t[e]="generative_model"===e||"summary_model"===e?{...n,options:(n.options||[]).filter((t=>"CHATGPT_AZURE3"===t.name||"NO_GENERATION"===t.name))}:n,t)),{})}(e):e)))})))}getUsers(t){return Nt([this.nuclia.db.getAccountUsers(t),this.nuclia.rest.get(`/account/${this.nuclia.options.accountId}/kb/${this.id}/users`,void 0,void 0,this.nuclia.options.zone)]).pipe(wt((([t,e])=>e.reduce(((e,n)=>{const r=t.find((t=>t.id===n.id));return r&&e.push({...r,role:n.role}),e}),[]))))}getInvites(){return this.nuclia.rest.get(`/account/${this.nuclia.options.accountId}/kb/${this.id}/invites`,void 0,void 0,this.nuclia.options.zone)}listenToAllNotifications(){return this.notifications||(this.notificationsController=new AbortController,this.notifications=ln(this.nuclia,this.path,this.notificationsController)),this.notifications}stopListeningToNotifications(){this.notificationsController&&(this.notificationsController.abort(hn),this.notificationsController=void 0,this.notifications=void 0)}listenToResourceOperationNotifications(){return this.listenToAllNotifications().pipe(wt((t=>(t.forEach((t=>{const e=t.data;this.resourceOperationStatus[e.resource_uuid]||"resource_written"!==t.type||(this.resourceOperationStatus[e.resource_uuid]={seqid:e.seqid,resource_title:e.resource_title,indexedNotificationCount:0,sequence:[]}),this.resourceOperationStatus[e.resource_uuid]&&("resource_indexed"===t.type?this.resourceOperationStatus[e.resource_uuid].indexedNotificationCount++:this.resourceOperationStatus[e.resource_uuid]={...this.resourceOperationStatus[e.resource_uuid],...e,sequence:[...this.resourceOperationStatus[e.resource_uuid].sequence,t.type]})})),Object.entries(this.resourceOperationStatus).reduce(((t,[e,n])=>(n.operation&&("deleted"===n.operation||n.sequence.includes("resource_processed")&&n.indexedNotificationCount>=2)&&t.push({resourceId:e,resourceTitle:n.resource_title,success:"deleted"===n.operation&&!n.error||"deleted"!==n.operation&&!n.error&&!n.processing_errors&&!!n.ingestion_succeeded,timestamp:(new Date).toISOString(),operation:n.operation}),t)),[])))),Ht((t=>{t.forEach((t=>delete this.resourceOperationStatus[t.resourceId]))})))}listenToProcessingNotifications(){return this.listenToAllNotifications().pipe(wt((t=>(t.forEach((t=>{const e=t.data;this.resourceProcessingStatus[e.resource_uuid]||(this.resourceProcessingStatus[e.resource_uuid]={seqid:e.seqid,resource_title:e.resource_title,indexedNotificationCount:0,sequence:[]}),"resource_indexed"===t.type?this.resourceProcessingStatus[e.resource_uuid].indexedNotificationCount++:this.resourceProcessingStatus[e.resource_uuid]={...this.resourceProcessingStatus[e.resource_uuid],...e,sequence:[...this.resourceProcessingStatus[e.resource_uuid].sequence,t.type]}})),Object.entries(this.resourceProcessingStatus).reduce(((t,[e,n])=>(n.sequence.includes("resource_processed")&&n.indexedNotificationCount>=2&&t.push({resourceId:e,resourceTitle:n.resource_title,success:!n.error&&!n.processing_errors&&!!n.ingestion_succeeded,timestamp:new Date(Date.now()).toISOString()}),t)),[])))),Ht((t=>{t.forEach((t=>delete this.resourceProcessingStatus[t.resourceId]))})))}processingStatus(t,e,n){const r=new URLSearchParams;return t&&r.set("cursor",t),"boolean"==typeof e&&r.set("scheduled",`${e}`),"number"==typeof n&&r.set("limit",`${n}`),this.nuclia.rest.get(`${this.path}/processing-status?${r}`)}}class fn extends pn{admin;contrib;_training;get training(){return this._training||(this._training=new cn(this,this.nuclia)),this._training}modify(t){const{endpoint:e,zone:n}=this.getKbEndpointAndZone();return this.nuclia.rest.patch(e,t,void 0,void 0,void 0,n)}delete(){const{endpoint:t,zone:e}=this.getKbEndpointAndZone();return this.nuclia.rest.delete(t,void 0,void 0,e)}getKbEndpointAndZone(){let t,e;return"local"===this.accountId?t=`/kb/${this.id}`:(t=`/account/${this.nuclia.options.accountId}/kb/${this.id}`,e=this.nuclia.options.zone),{endpoint:t,zone:e}}publish(t){return this.modify({state:t?"PUBLISHED":"PRIVATE"})}createEntitiesGroup(t,e){return this.nuclia.rest.post(`${this.path}/entitiesgroups`,{...e,group:t})}updateEntitiesGroup(t,e){return this.nuclia.rest.patch(`${this.path}/entitiesgroup/${t}`,e)}deleteEntitiesGroup(t){return this.nuclia.rest.delete(`${this.path}/entitiesgroup/${t}`)}setLabelSet(t,e){return this.nuclia.rest.post(`${this.path}/labelset/${t}`,e)}deleteLabelSet(t){return this.nuclia.rest.delete(`${this.path}/labelset/${t}`)}setSynonyms(t){return this.nuclia.rest.put(`${this.path}/custom-synonyms`,{synonyms:t})}deleteAllSynonyms(){return this.nuclia.rest.delete(`${this.path}/custom-synonyms`)}createResource(t,e=!0){return this.nuclia.rest.post(`${this.path}/resources`,t,void 0,void 0,e)}createLinkResource(t,e,n=!0,r){return this.createResource({links:{link:t},usermetadata:e,title:t.uri,icon:"application/stf-link",...r?{origin:r}:{}},n)}hasResource(t){return this.nuclia.rest.get(`${this.path}/slug/${t}`).pipe(wt((()=>!0)),Dt((()=>vt(!1))))}createOrUpdateResource(t,e=!0){return(t.slug?this.hasResource(t.slug):vt(!1)).pipe(Bt((n=>n?this.getResourceFromData({id:"",slug:t.slug}).modify(t,e):this.createResource(t,e))))}upload(t,e,n){return ue(this.nuclia,`/kb/${this.id}`,t,!!e,n)}batchUpload(t){return he(this.nuclia,`/kb/${this.id}`,t,!1)}getServiceAccounts(){const{endpoint:t,zone:e}=this.getKbEndpointAndZone();return this.nuclia.rest.get(`${t}/service_accounts`,void 0,void 0,e)}createServiceAccount(t){const{endpoint:e,zone:n}=this.getKbEndpointAndZone();return this.nuclia.rest.post(`${e}/service_accounts`,t,void 0,void 0,void 0,n)}deleteServiceAccount(t){const{endpoint:e,zone:n}=this.getKbEndpointAndZone();return this.nuclia.rest.delete(`${e}/service_account/${t}`,void 0,void 0,n)}createKey(t,e){const{endpoint:n,zone:r}=this.getKbEndpointAndZone();return this.nuclia.rest.post(`${n}/service_account/${t}/keys`,{expires:e},void 0,void 0,void 0,r)}createKeyForService(t,e){return this.getServiceAccounts().pipe(Bt((e=>{const n=e.find((e=>e.title===t.title&&e.role===t.role));return n?vt(n):this.createServiceAccount(t).pipe(Bt((()=>this.getServiceAccounts())),wt((e=>e.find((e=>e.title===t.title&&e.role===t.role)))))})),Bt((t=>t?this.createKey(t.id,e):vt({token:""}))))}deleteKey(t,e){const{endpoint:n,zone:r}=this.getKbEndpointAndZone();return this.nuclia.rest.delete(`${n}/service_account/${t}/key/${e}`,void 0,void 0,r)}setConfiguration(t){return this.nuclia.rest.patch(`/kb/${this.id}/configuration`,t)}updateUsers(t){const{endpoint:e,zone:n}=this.getKbEndpointAndZone();return this.nuclia.rest.patch(`${e}/users`,t,void 0,void 0,void 0,n)}inviteToKb(t){const{endpoint:e,zone:n}=this.getKbEndpointAndZone();return this.nuclia.rest.post(`${e}/invite`,t,void 0,void 0,void 0,n)}deleteInvite(t){const{endpoint:e,zone:n}=this.getKbEndpointAndZone();return this.nuclia.rest.delete(`${e}/invite?email=${t}`,void 0,void 0,n)}}var gn,bn;!function(t){t.RESOURCES="RESOURCES",t.PARAGRAPHS="PARAGRAPHS",t.SELECTIONS="SELECTIONS"}(gn||(gn={})),function(t){t.VISITED="VISITED",t.MODIFIED="MODIFIED",t.DELETED="DELETED",t.NEW="NEW",t.STARTED="STARTED",t.STOPPED="STOPPED",t.SEARCH="SEARCH",t.PROCESSED="PROCESSED",t.CHAT="CHAT"}(bn||(bn={}));class vn{nuclia;constructor(t){this.nuclia=t}getAccounts(){return this.nuclia.rest.get("/accounts")}getKbIndexes(t){return this.nuclia.rest.get(`/account/${t}/index/kbs`)}createAccount(t){return this.nuclia.rest.post("/accounts",t)}modifyAccount(t,e){return this.nuclia.rest.patch(`/account/${t}`,e)}deleteAccount(t){return this.nuclia.rest.delete(`/account/${t}`)}getAccountStatus(t){return this.nuclia.rest.get(`/account/${t}/status`)}getWelcome(){return this.nuclia.rest.get("/user/welcome")}getAccount(t){if(!(t=t||this.nuclia.options.account))throw new Error("Account is not set");return this.nuclia.rest.get(`/account/${t}`)}getStandaloneKbs(){return this.nuclia.rest.get("/kbs").pipe(wt((t=>t.kbs)))}getKnowledgeBoxes(t,e){const n=t||this.nuclia.options.account,r=e||this.nuclia.options.accountId;return n&&r?Nt([this.nuclia.rest.getZones(),this.getKbIndexes(n)]).pipe(Bt((([t,e])=>{const n=e.reduce(((e,n)=>{const r=t[n.zone_id];return e.includes(r)||e.push(r),e}),[]);return n.length>0?Nt(n.map((t=>this.getKnowledgeBoxesForZone(r,t)))):vt([])})),wt((t=>t.reduce(((t,e)=>t.concat(e)),[])))):yt((()=>"Account slug and ID must be provided in order to load KBs. You can provide them as parameter or in Nuclia options."))}getKnowledgeBoxesForZone(t,e){return this.nuclia.rest.get(`/account/${t}/kbs`,void 0,void 0,e)}getKnowledgeBox(t,e,n){const r=t||this.nuclia.options.accountId,i=e||this.nuclia.options.knowledgeBox,o=n||this.nuclia.options.zone;if(r||this.nuclia.options.standalone){if(!(this.nuclia.options.standalone||this.nuclia.options.proxy||i&&o))throw new Error("Knowledge Box id and zone must be provided as parameters or in the Nuclia options");const t=this.nuclia.options.standalone?`/kb/${i}`:`/account/${r}/kb/${i}`;return this.nuclia.rest.get(t,void 0,void 0,this.nuclia.options.standalone||this.nuclia.options.proxy?void 0:o).pipe(wt((t=>new fn(this.nuclia,r,t))))}if(!this.nuclia.options.knowledgeBox&&!i||!this.nuclia.options.zone&&!n)throw new Error("Knowledge Box id and zone must be provided as parameters or in the Nuclia options");return vt(new fn(this.nuclia,"",{id:e||this.nuclia.options.knowledgeBox,zone:n||this.nuclia.options.zone}))}createKnowledgeBox(t,e,n){let r;return r=this.nuclia.options.standalone?this.nuclia.rest.post("/kbs",e):this.nuclia.rest.post(`/account/${t}/kbs`,e,void 0,void 0,void 0,n),r.pipe(Bt((e=>{const r=e.id||e.uuid;if(!r)throw"Knowledge Box creation failed";return this.getKnowledgeBox(t,r,n)})))}getStats(t,e,n,r=Yt.DAY,i){const o=[`period=${r}`,`stats=${e}`];return i&&o.push(`utctime=${i}`),n&&o.push(`knowledgebox=${n}`),this.nuclia.rest.get(`/account/${t}/stats?${o.join("&")}`).pipe(wt((t=>t.data)),Pt((t=>!!t)))}upload(t){if(!this.hasNUAClient())throw new Error("NUA key is needed to be able to call /process");return de(this.nuclia,this.getNUAKey(),t,{md5:t.md5}).pipe(Bt((t=>this.nuclia.rest.post("/processing/push",{filefield:{file:t}},this.getNUAHeader()))))}pull(){if(!this.hasNUAClient())throw new Error("NUA key is needed to be able to call /processing");return this.nuclia.rest.get("/processing/pull",this.getNUAHeader())}getProcessingStats(t,e){const n=this.hasNUAClient();if(!e&&!n)throw new Error("NUA key or account id is needed to be able to call /processing/stats");const r=n?"/processing/stats"+(t?"?period="+t:""):`/processing/stats?account_id=${e}${t?"&period="+t:""}`,i=n?this.getNUAHeader():void 0;return this.nuclia.rest.get(r,i).pipe(wt((t=>t.data)))}getNUAActivity(t,e,n,r=0){return this.nuclia.rest.get(`/account/${t}/nua_client/${e}/activity?page=${r}`,void 0,void 0,n)}getNUAClients(t){return this.nuclia.rest.getZones().pipe(Bt((e=>Nt(Object.values(e).map((e=>this.nuclia.rest.get(`/account/${t}/nua_clients`,void 0,void 0,e).pipe(wt((({clients:t})=>t.map((t=>({...t,zone:e}))))),Dt((()=>vt([]))))))))),wt((t=>t.reduce(((t,e)=>t.concat(e)),[]))))}getNUAClient(t,e,n){return this.nuclia.rest.get(`/account/${t}/nua_client/${e}`,void 0,void 0,n)}hasNUAClient(){return!!this.getNUAKey()}getNUAKey(){return this.nuclia.options.nuaKey||""}getNUAHeader(){return{"x-nuclia-nuakey":`Bearer ${this.getNUAKey()}`}}createNUAClient(t,e,n){if(!t||!e){const t="Account and data are required to create a NUA client";return console.error(t),yt((()=>t))}const r={...e};return r.webhook&&(r.processing_webhook={uri:r.webhook},delete r.webhook),this.nuclia.rest.post(`/account/${t}/nua_clients`,r,void 0,void 0,void 0,n).pipe(Dt((n=>{if(409===n.status&&e.client_id)return this.renewNUAClient(t,e.client_id);throw n})),Ht((t=>{"desktop"===this.nuclia.options.client&&(this.nuclia.options.nuaKey=t.token,localStorage.setItem(Jt,t.token))})))}renewNUAClient(t,e,n){return this.nuclia.rest.put(`/account/${t}/nua_client/${e}/key`,{},void 0,void 0,void 0,n)}deleteNUAClient(t,e,n){return this.nuclia.rest.delete(`/account/${t}/nua_client/${e}`,void 0,void 0,n)}getLearningSchema(t,e){const n=this.nuclia.options.standalone;if(!(n||t&&e)){const t="Account id and zone are mandatory to get learning schema for Cloud accounts.";return console.error(t),yt((()=>t))}return(n?this.nuclia.rest.get("/nua/schema"):this.nuclia.rest.get(`/account/${t}/schema`,void 0,void 0,e)).pipe(wt((t=>ee(t))))}predictTokens(t){if(!this.hasNUAClient())throw new Error("NUA key is needed to be able to call /predict");return this.nuclia.rest.get(`/predict/tokens?text=${encodeURIComponent(t)}`,this.getNUAHeader()).pipe(wt((t=>t.tokens)))}predictAnswer(t,e,n){if(!this.hasNUAClient())throw new Error("NUA key is needed to be able to call /predict");const r=n?`?model=${encodeURIComponent(n)}`:"";return this.nuclia.rest.post(`/predict/chat${r}`,{question:t,user_id:"Anonymous",query_context:e},this.getNUAHeader(),!0).pipe(Lt((t=>bt(t.text()))),wt((t=>t.slice(0,-1))))}predictSummarize(t,e,n="chatgpt-azure-3",r="simple"){if(!this.hasNUAClient())throw new Error("NUA key is needed to be able to call /predict");const i=n?`?model=${encodeURIComponent(n)}`:"",o=[0,1e3,2e3,5e3,1e4],s={count:o.length,delay:(t,e)=>Ct(o[e-1])};return It((()=>this.nuclia.rest.post(`/predict/summarize${i}`,{resources:{text:{fields:{text:t}}},summary_kind:r,user_prompt:e},this.getNUAHeader()))).pipe(Ft(s),wt((t=>t.summary)))}getAccountUser(t,e){return this.nuclia.rest.get(`/account/${t}/user/${e}`)}getAccountUsers(t){return this.nuclia.rest.get(`/account/${t}/users`)}setAccountUsers(t,e){const n=`/account/${t}/users`;return this.nuclia.rest.patch(n,e)}inviteToAccount(t,e){const n=`/account/${t}/invite`;return this.nuclia.rest.post(n,e)}getAccountInvitations(t){return this.nuclia.rest.get(`/account/${t}/invites`)}deleteAccountInvitation(t,e){return this.nuclia.rest.delete(`/account/${t}/invite/${e}`)}}class yn{messages=new j;emit(t,e){this.messages.next({name:t,data:e})}on(t){return this.messages.asObservable().pipe(Pt((e=>e.name===t)),wt((t=>t.data)))}}class mn{options;auth;rest;db;currentShards={};events=new yn;readKb;get backend(){return this.options.backend}get regionalBackend(){return this.options.backend.replace("//",`//${this.options.zone}.`)}get knowledgeBox(){if(!this.options.knowledgeBox||!this.options.zone&&!this.options.standalone&&!this.options.proxy)throw new Error("zone and knowledge box id must be defined in the Nuclia options");return this.readKb||(this.readKb=new pn(this,"",{id:this.options.knowledgeBox,zone:this.options.zone||""})),this.readKb}get asyncKnowledgeBox(){return new Proxy(this.knowledgeBox,{get(t,e){const n=Reflect.get(t,e);return"function"==typeof n?(...e)=>function(t,e){var n="object"==typeof e;return new Promise((function(r,i){var o=new k({next:function(t){r(t),o.unsubscribe()},error:i,complete:function(){n?r(e.defaultValue):i(new mt)}});t.subscribe(o)}))}(n.bind(t)(...e)):n}})}constructor(t){this.options=t,this.auth=new Vt(this),this.rest=new dn(this),this.db=new vn(this)}}export{hn as ABORT_STREAMING_REASON,Zt as AccountBlockingState,Vt as Authentication,Xt as BlockedFeature,Be as Chat,Ae as ConversationFieldData,vn as Db,bn as EventType,ve as ExtractedDataTypes,fe as FIELD_TYPE,ye as FileFieldData,Ne as FilterOperator,Gt as JwtHelper,we as KeywordSetFieldData,pn as KnowledgeBox,Se as LABEL_FILTER_PREFIX,gn as LabelSetKind,Ee as LinkFieldData,$e as NER_FILTER_PREFIX,Jt as NUA_KEY,mn as Nuclia,ge as RESOURCE_STATUS,Ye as ReadableResource,Qe as Resource,be as ResourceFieldProperties,ie as ResourceProperties,dn as Rest,Ce as SHORT_FIELD_TYPE,re as SUMMARY_PROMPT,Ue as Search,Ie as SortField,Yt as StatsPeriod,Qt as StatsRange,te as StatsType,le as TUSuploadFile,me as TextFieldData,cn as Training,un as TrainingExecutionStatus,an as TrainingStatus,sn as TrainingType,ne as USER_PROMPTS,fn as WritableKnowledgeBox,he as batchUpload,Le as catalog,Ge as chat,We as deDuplicateList,Pe as find,ln as getAllNotifications,en as getDataKeyFromFieldType,Re as getEntityFromFilter,on as getFieldTypeFromString,pe as getFileMetadata,Oe as getFilterFromEntity,_e as getFilterFromLabel,xe as getFilterFromLabelSet,Te as getLabelFromFilter,ke as getLabelSetFromFilter,Xe as lengthUnicode,nn as longToShortFieldType,ee as normalizeSchemaProperty,tn as resourceToAlgoliaFormat,De as search,qe as setEntities,Me as setLabels,rn as shortToLongFieldType,Ze as sliceUnicode,ze as suggest,ue as upload,ce as uploadFile,de as uploadToProcess};
